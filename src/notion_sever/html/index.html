<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>名刺処理アップローダー</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* 引き継ぎリストのテーブル用スタイル（任意） */
    #handover-list-table th,
    #handover-list-table td {
      padding: 8px 12px;
      border: 1px solid #e5e7eb; /* gray-200 */
      text-align: left;
    }
    #handover-list-table tbody tr:hover {
      background-color: #f3f4f6; /* gray-100 */
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- PC用レイアウト -->
  <div class="hidden lg:block">
    <div class="container mx-auto px-8 py-12">
      <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg">
        <div class="p-8">
          <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">リードデータベース管理システム</h1>
          

          {% if message %}
            <div class="mb-6 p-4 text-center rounded-lg {{ 'bg-green-50 text-green-700 border border-green-200' if success == '1' else 'bg-red-50 text-red-700 border border-red-200' }}">
              {{ message|safe }}
            </div>
          {% endif %}

          <form method="post" enctype="multipart/form-data" id="pc-upload-form" class="space-y-8">
            
            <!-- 第1セクション: 基本情報 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              
              <!-- 左カラム: 担当者・名刺情報 -->
              <div class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">基本情報</h2>
                
                <!-- 担当者 -->
                <div>
                  <label for="pc-tantosha-input" class="block text-sm font-medium text-gray-700 mb-2">担当者 <span class="text-red-500">*</span></label>
                  <select name="tantosha" id="pc-tantosha-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    <option value="" disabled {% if not tantosha_value %}selected{% endif %}>担当者を選択してください</option>
                    {% for assignee in assignees_list %}
                      <option value="{{ assignee }}" {% if assignee == tantosha_value %}selected{% endif %}>{{ assignee }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- 名刺情報 -->
                <div>
                  <label class="block text-lg font-medium text-gray-700 mb-3">名刺情報</label>
                  
                  <!-- 入力方法選択 -->
                  <div class="mb-4">
                    <div class="flex space-x-6">
                      <label class="inline-flex items-center">
                        <input type="radio" name="input_method" value="image" id="pc-input-method-image" class="form-radio h-5 w-5 text-indigo-600" checked>
                        <span class="ml-3 text-base">名刺画像</span>
                      </label>
                      <label class="inline-flex items-center">
                        <input type="radio" name="input_method" value="manual" id="pc-input-method-manual" class="form-radio h-5 w-5 text-indigo-600">
                        <span class="ml-3 text-base">手入力</span>
                      </label>
                    </div>
                  </div>
                  
                  <!-- 名刺画像セクション -->
                  <div id="pc-image-input-section">
                    <div class="flex space-x-3 mb-4">
                      <label for="pc-business-card-input" class="cursor-pointer inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                        📁 ファイルを選択
                      </label>
                      <button type="button" id="pc-business-card-camera" class="inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                        📷 カメラ
                      </button>
                    </div>
                    <input type="file" name="business_card" id="pc-business-card-input" accept="image/*" class="hidden">
                    <div id="pc-business-card-preview" class="mt-3 grid grid-cols-1 gap-3"></div>
                  </div>
                  
                  <!-- 手入力セクション -->
                  <div id="pc-manual-input-section" class="hidden space-y-4">
                    <div>
                      <label for="pc-manual-company" class="block text-sm font-medium text-gray-700 mb-2">会社名 <span class="text-red-500">*</span></label>
                      <input type="text" name="manual_company" id="pc-manual-company" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="株式会社○○">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label for="pc-manual-department" class="block text-sm font-medium text-gray-700 mb-2">部署名</label>
                        <input type="text" name="manual_department" id="pc-manual-department" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="営業部">
                      </div>
                      <div>
                        <label for="pc-manual-position" class="block text-sm font-medium text-gray-700 mb-2">役職名</label>
                        <input type="text" name="manual_position" id="pc-manual-position" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="課長">
                      </div>
                    </div>
                    <div>
                      <label for="pc-manual-name" class="block text-sm font-medium text-gray-700 mb-2">担当者氏名 <span class="text-red-500">*</span></label>
                      <input type="text" name="manual_name" id="pc-manual-name" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="田中太郎">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label for="pc-manual-email" class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                        <input type="email" name="manual_email" id="pc-manual-email" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="tanaka@example.com">
                      </div>
                      <div>
                        <label for="pc-manual-phone" class="block text-sm font-medium text-gray-700 mb-2">電話番号</label>
                        <input type="tel" name="manual_phone" id="pc-manual-phone" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="03-1234-5678">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ヒアリングシート -->
                <div>
                  <label class="block text-lg font-medium text-gray-700 mb-3">ヒアリングシート画像（複数可）</label>
                  <div class="flex space-x-3 mb-4">
                    <label for="pc-hearing-seed-input" class="cursor-pointer inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                      📁 ファイルを選択
                    </label>
                    <button type="button" id="pc-hearing-sheet-camera" class="inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                      📷 カメラ
                    </button>
                  </div>
                  <input type="file" name="hearing_seed" id="pc-hearing-seed-input" multiple accept="image/*" class="hidden">
                  <div id="pc-hearing-seed-preview" class="mt-3 grid grid-cols-4 gap-3"></div>
                </div>
              </div>

              <!-- 右カラム: プラン・ペルソナ -->
              <div class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">営業情報</h2>
                
                <!-- 提案プラン -->
                <div>
                  <label for="pc-proposal-plan-input" class="block text-sm font-medium text-gray-700 mb-2">提案（興味がありそうな）プラン <span class="text-red-500">*</span></label>
                  <select name="proposal_plan" id="pc-proposal-plan-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    <option value="" disabled {% if not proposal_plan_value %}selected{% endif %}>プランを選択してください</option>
                    {% for plan in proposal_plan_list %}
                      <option value="{{ plan }}" {% if plan == proposal_plan_value %}selected{% endif %}>{{ plan }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- ペルソナ -->
                <div>
                  <h3 class="text-lg font-semibold text-gray-800 mb-4">ペルソナ</h3>
                  <div class="grid grid-cols-3 gap-4 mb-6">
                    <div>
                      <label for="pc-needs-input" class="block text-sm font-medium text-gray-700 mb-2">ニーズ <span class="text-red-500">*</span></label>
                      <select name="needs" id="pc-needs-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        <option value="" disabled {% if not needs_value %}selected{% endif %}>選択</option>
                        {% for option_value, option_text in persona_options.needs %}
                          <option value="{{ option_value }}" {% if option_value == needs_value %}selected{% endif %}>{{ option_text }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div>
                      <label for="pc-authority-input" class="block text-sm font-medium text-gray-700 mb-2">決裁権 <span class="text-red-500">*</span></label>
                      <select name="authority" id="pc-authority-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        <option value="" disabled {% if not authority_value %}selected{% endif %}>選択</option>
                        {% for option_value, option_text in persona_options.authority %}
                          <option value="{{ option_value }}" {% if option_value == authority_value %}selected{% endif %}>{{ option_text }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div>
                      <label for="pc-timing-input" class="block text-sm font-medium text-gray-700 mb-2">導入時期 <span class="text-red-500">*</span></label>
                      <select name="timing" id="pc-timing-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        <option value="" disabled {% if not timing_value %}selected{% endif %}>選択</option>
                        {% for option_value, option_text in persona_options.timing %}
                          <option value="{{ option_value }}" {% if option_value == timing_value %}selected{% endif %}>{{ option_text }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <!-- リード獲得日とボイレコ -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="pc-lead-date-input" class="block text-sm font-medium text-gray-700 mb-2">リード獲得日 (YYYY/M/D形式)</label>
                    <input type="text" name="lead_date" id="pc-lead-date-input" placeholder="デフォルトは当日になります" value="{{ lead_date_value }}" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                  </div>
                  <div>
                    <label for="pc-voice-recorder-loan-input" class="block text-sm font-medium text-gray-700 mb-2">ボイスレコーダー貸し出し</label>
                    <input type="text" name="voice_recorder_loan" id="pc-voice-recorder-loan-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="管理番号を入力（例：VR001）" value="{{ voice_recorder_loan_value }}">
                  </div>
                </div>
              </div>
            </div>

            <!-- 第2セクション: ヒアリング詳細 -->
            <div class="border-t pt-8">
              <h2 class="text-xl font-semibold text-gray-800 mb-6">ヒアリング詳細</h2>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label for="pc-current-situation-input" class="block text-sm font-medium text-gray-700 mb-2">現状</label>
                  <textarea name="current_situation" id="pc-current-situation-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="お客様の現在の状況を記述してください">{{ current_situation_value }}</textarea>
                </div>
                <div>
                  <label for="pc-problem-input" class="block text-sm font-medium text-gray-700 mb-2">問題</label>
                  <textarea name="problem" id="pc-problem-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="お客様が抱えている問題を記述してください">{{ problem_value }}</textarea>
                </div>
                <div>
                  <label for="pc-most-important-need-input" class="block text-sm font-medium text-gray-700 mb-2">最重要ニーズ</label>
                  <textarea name="most_important_need" id="pc-most-important-need-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="お客様が最も解決したいと考えているニーズを記述してください">{{ most_important_need_value }}</textarea>
                </div>
                <div>
                  <label for="pc-proposal-content-input" class="block text-sm font-medium text-gray-700 mb-2">提案内容</label>
                  <textarea name="proposal_content" id="pc-proposal-content-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="具体的な提案内容を記述してください">{{ proposal_content_value }}</textarea>
                </div>
              </div>
              <div class="mt-4">
                <label for="pc-consideration-reason-input" class="block text-sm font-medium text-gray-700 mb-2">検討理由</label>
                <textarea name="consideration_reason" id="pc-consideration-reason-input" rows="3" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="お客様が提案を検討する理由や背景を記述してください">{{ consideration_reason_value }}</textarea>
              </div>
            </div>

            <!-- 送信ボタン -->
            <div class="flex items-center justify-center pt-6 border-t">
              <button id="pc-submit-btn" type="submit" class="px-12 py-4 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition flex items-center text-lg">
                <span id="pc-btn-text">処理開始</span>
                <svg id="pc-btn-spinner" class="hidden animate-spin ml-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
                </svg>
              </button>
            </div>


          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- スマホ用レイアウト -->
  <div class="lg:hidden flex items-center justify-center p-4 min-h-screen">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-semibold text-center mb-6">リードデータベース</h1>


    {% if message %}
      <p class="mt-4 text-center {{ 'text-green-600' if success == '1' else 'text-red-600' }}">
        {{ message|safe }}
      </p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="mobile-upload-form" class="space-y-6">
      <div>
        <label for="tantosha-input" class="block text-sm font-medium text-gray-700 mb-1">担当者 <span class="text-red-500">*</span></label>
        <select name="tantosha" id="tantosha-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
          <option value="" disabled {% if not tantosha_value %}selected{% endif %}>担当者を選択してください</option>
          {% for assignee in assignees_list %}
            <option value="{{ assignee }}" {% if assignee == tantosha_value %}selected{% endif %}>{{ assignee }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block font-medium mb-1">名刺情報</label>
        
        <!-- 入力方法選択 -->
        <div class="mb-3">
          <label class="inline-flex items-center mr-4">
            <input type="radio" name="input_method" value="image" id="input-method-image" class="form-radio" checked>
            <span class="ml-2">名刺画像</span>
          </label>
          <label class="inline-flex items-center">
            <input type="radio" name="input_method" value="manual" id="input-method-manual" class="form-radio">
            <span class="ml-2">手入力</span>
          </label>
        </div>
        
        <!-- 名刺画像セクション -->
        <div id="image-input-section">
          <div class="flex space-x-2">
            <label for="business-card-input" class="cursor-pointer inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
              ファイルを選択
            </label>
            <button type="button" id="business-card-camera" class="inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
              カメラ
            </button>
          </div>
          <input type="file" name="business_card" id="business-card-input" accept="image/*" class="hidden">
          <div id="business-card-preview" class="mt-2 grid grid-cols-1 gap-2"></div>
        </div>
        
        <!-- 手入力セクション -->
        <div id="manual-input-section" class="hidden space-y-3">
          <div>
            <label for="manual-company" class="block text-sm font-medium text-gray-700 mb-1">会社名 <span class="text-red-500">*</span></label>
            <input type="text" name="manual_company" id="manual-company" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="株式会社○○">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="manual-department" class="block text-sm font-medium text-gray-700 mb-1">部署名</label>
              <input type="text" name="manual_department" id="manual-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="営業部">
            </div>
            <div>
              <label for="manual-position" class="block text-sm font-medium text-gray-700 mb-1">役職名</label>
              <input type="text" name="manual_position" id="manual-position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="課長">
            </div>
          </div>
          <div>
            <label for="manual-name" class="block text-sm font-medium text-gray-700 mb-1">担当者氏名 <span class="text-red-500">*</span></label>
            <input type="text" name="manual_name" id="manual-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="田中太郎">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="manual-email" class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
              <input type="email" name="manual_email" id="manual-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="tanaka@example.com">
            </div>
            <div>
              <label for="manual-phone" class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
              <input type="tel" name="manual_phone" id="manual-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="03-1234-5678">
            </div>
          </div>
        </div>
      </div>

      <div>
        <label class="block font-medium mb-1">ヒアリングシート画像（複数可）</label>
         <div class="flex space-x-2">
            <label for="hearing-seed-input" class="cursor-pointer inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
                ファイルを選択
            </label>
            <button type="button" id="hearing-sheet-camera" class="inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                カメラ
            </button>
        </div>
        <input type="file" name="hearing_seed" id="hearing-seed-input" multiple accept="image/*" class="hidden">
        <div id="hearing-seed-preview" class="mt-2 grid grid-cols-3 gap-2"></div>
      </div>

      
      <div>
        <label for="proposal-plan-input" class="block text-sm font-medium text-gray-700 mb-1">提案（興味がありそうな）プラン<span class="text-red-500">*</span></label>
        <select name="proposal_plan" id="proposal-plan-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
          <option value="" disabled {% if not proposal_plan_value %}selected{% endif %}>プランを選択してください</option>
          {% for plan in proposal_plan_list %}
            <option value="{{ plan }}" {% if plan == proposal_plan_value %}selected{% endif %}>{{ plan }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- ここからペルソナセクション -->
      <hr class="border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800 -mb-2 pt-2">ペルソナ</h2>

      <div class="grid grid-cols-3 gap-4">
        <div class="flex-1">
            <label for="needs-input" class="block text-sm font-medium text-gray-700 mb-1">ニーズ<span class="text-red-500">*</span></label>
            <select name="needs" id="needs-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                <option value="" disabled {% if not needs_value %}selected{% endif %}>選択</option>
                {# persona_options辞書の'needs'キーに対応するリストをループ #}
                {% for option_value, option_text in persona_options.needs %}
                  <option value="{{ option_value }}" {% if option_value == needs_value %}selected{% endif %}>{{ option_text }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="flex-1">
            <label for="authority-input" class="block text-sm font-medium text-gray-700 mb-1">決裁権<span class="text-red-500">*</span></label>
            <select name="authority" id="authority-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                <option value="" disabled {% if not authority_value %}selected{% endif %}>選択</option>
                {# persona_options辞書の'authority'キーに対応するリストをループ #}
                {% for option_value, option_text in persona_options.authority %}
                  <option value="{{ option_value }}" {% if option_value == authority_value %}selected{% endif %}>{{ option_text }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="flex-1">
            <label for="timing-input" class="block text-sm font-medium text-gray-700 mb-1">導入時期<span class="text-red-500">*</span></label>
            <select name="timing" id="timing-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                <option value="" disabled {% if not timing_value %}selected{% endif %}>選択</option>
                {# persona_options辞書の'timing'キーに対応するリストをループ #}
                {% for option_value, option_text in persona_options.timing %}
                  <option value="{{ option_value }}" {% if option_value == timing_value %}selected{% endif %}>{{ option_text }}</option>
                {% endfor %}
            </select>
        </div>
      </div>

      <hr class="border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800 -mb-2 pt-2">ヒアリング内容</h2>

      <div>
        <label for="current-situation-input" class="block text-sm font-medium text-gray-700 mb-1">現状</label>
        <textarea name="current_situation" id="current-situation-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="現在のお客様の状況について記述してください">{{ current_situation_value }}</textarea>
      </div>

      <div>
        <label for="problem-input" class="block text-sm font-medium text-gray-700 mb-1">問題</label>
        <textarea name="problem" id="problem-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="お客様が抱えている問題点を記述してください">{{ problem_value }}</textarea>
      </div>

      <div>
        <label for="most-important-need-input" class="block text-sm font-medium text-gray-700 mb-1">最重要ニーズ</label>
        <textarea name="most_important_need" id="most-important-need-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="お客様が最も解決したいと考えているニーズを記述してください">{{ most_important_need_value }}</textarea>
      </div>

      <div>
        <label for="proposal-content-input" class="block text-sm font-medium text-gray-700 mb-1">提案内容</label>
        <textarea name="proposal_content" id="proposal-content-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="具体的な提案内容を記述してください">{{ proposal_content_value }}</textarea>
      </div>

      <div>
        <label for="consideration-reason-input" class="block text-sm font-medium text-gray-700 mb-1">検討理由</label>
        <textarea name="consideration_reason" id="consideration-reason-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="お客様が提案を検討する理由や背景を記述してください">{{ consideration_reason_value }}</textarea>
      </div>

      <div>
        <label for="lead-date-input" class="block font-medium">リード獲得日 (YYYY/M/D形式)</label> <input type="text" name="lead_date" id="lead-date-input" placeholder="デフォルトは当日になります" value="{{ lead_date_value }}" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"> </div>

      <div>
        <label for="voice-recorder-loan-input" class="block text-sm font-medium text-gray-700 mb-1">ボイスレコーダー貸し出し</label>
        <input type="text" name="voice_recorder_loan" id="voice-recorder-loan-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="管理番号を入力（例：VR001）" value="{{ voice_recorder_loan_value }}">
        <p class="mt-1 text-xs text-gray-500">ボイスレコーダーを貸し出した場合の管理番号を入力してください</p>
      </div>

      <div class="flex items-center justify-center pt-4">
          <button id="submit-btn" type="submit" class="w-full py-3 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition flex items-center justify-center">
              <span id="btn-text">アップロード</span>
              <svg id="btn-spinner" class="hidden animate-spin ml-2 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/></svg>
          </button>
      </div>


    </form>

    </div>
  </div>

  <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-4 rounded-lg max-w-lg w-full">
        <h3 class="text-lg font-medium mb-2" id="camera-modal-title">写真を撮影</h3>
        <div class="relative">
          <video id="camera-video" class="w-full h-64 bg-black object-cover" autoplay playsinline></video>
          <canvas id="camera-canvas" class="hidden"></canvas>
        </div>
        <div class="flex justify-between mt-4">
          <button type="button" id="camera-cancel" class="px-4 py-2 bg-gray-200 rounded-lg">キャンセル</button>
          <button type="button" id="camera-capture" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">撮影</button>
        </div>
    </div>
  </div>

  <script>
    // 入力方法の切り替え（PC・モバイル共通）
    document.addEventListener('DOMContentLoaded', function() {
      // モバイル用の要素
      const imageRadio = document.getElementById('input-method-image');
      const manualRadio = document.getElementById('input-method-manual');
      const imageSection = document.getElementById('image-input-section');
      const manualSection = document.getElementById('manual-input-section');
      const businessCardInput = document.getElementById('business-card-input');
      const manualCompany = document.getElementById('manual-company');
      const manualName = document.getElementById('manual-name');
      
      // PC用の要素
      const pcImageRadio = document.getElementById('pc-input-method-image');
      const pcManualRadio = document.getElementById('pc-input-method-manual');
      const pcImageSection = document.getElementById('pc-image-input-section');
      const pcManualSection = document.getElementById('pc-manual-input-section');
      const pcBusinessCardInput = document.getElementById('pc-business-card-input');
      const pcManualCompany = document.getElementById('pc-manual-company');
      const pcManualName = document.getElementById('pc-manual-name');
      
      function toggleInputMethod() {
        // モバイル用の処理
        if (imageRadio && manualRadio) {
          if (manualRadio.checked) {
            imageSection.classList.add('hidden');
            manualSection.classList.remove('hidden');
            businessCardInput.removeAttribute('required');
            manualCompany.setAttribute('required', 'required');
            manualName.setAttribute('required', 'required');
          } else {
            imageSection.classList.remove('hidden');
            manualSection.classList.add('hidden');
            businessCardInput.setAttribute('required', 'required');
            manualCompany.removeAttribute('required');
            manualName.removeAttribute('required');
          }
        }
      }
      
      function togglePcInputMethod() {
        // PC用の処理
        if (pcImageRadio && pcManualRadio) {
          if (pcManualRadio.checked) {
            pcImageSection.classList.add('hidden');
            pcManualSection.classList.remove('hidden');
            pcBusinessCardInput.removeAttribute('required');
            pcManualCompany.setAttribute('required', 'required');
            pcManualName.setAttribute('required', 'required');
          } else {
            pcImageSection.classList.remove('hidden');
            pcManualSection.classList.add('hidden');
            pcBusinessCardInput.setAttribute('required', 'required');
            pcManualCompany.removeAttribute('required');
            pcManualName.removeAttribute('required');
          }
        }
      }
      
      // モバイル用イベントリスナー
      if (imageRadio && manualRadio) {
        imageRadio.addEventListener('change', toggleInputMethod);
        manualRadio.addEventListener('change', toggleInputMethod);
        toggleInputMethod(); // 初期状態を設定
      }
      
      // PC用イベントリスナー
      if (pcImageRadio && pcManualRadio) {
        pcImageRadio.addEventListener('change', togglePcInputMethod);
        pcManualRadio.addEventListener('change', togglePcInputMethod);
        togglePcInputMethod(); // 初期状態を設定
      }
    });
    // --- ▼▼▼ 初期化・既存機能 ▼▼▼ ---

    // ページ読み込み時にカメラ許可を確認
    window.addEventListener('DOMContentLoaded', () => {
      // ブラウザがカメラAPIをサポートしているか確認
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // 初回アクセス時にカメラ許可を求めるダイアログを表示
        if (!localStorage.getItem('cameraPermissionRequested')) {
          setTimeout(() => {
            if (confirm('このアプリはカメラ機能を使用します。カメラへのアクセスを許可しますか？')) {
              // カメラへのアクセス許可を求める
              navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                  // 許可された場合、ストリームを停止
                  stream.getTracks().forEach(track => track.stop());
                  console.log('カメラへのアクセスが許可されました');
                  localStorage.setItem('cameraPermissionGranted', 'true');
                })
                .catch(err => {
                  console.error('カメラへのアクセスが拒否されました:', err);
                });
            }
            // 許可を求めたことを記録
            localStorage.setItem('cameraPermissionRequested', 'true');
          }, 1000); // 1秒後に表示
        }
      }
    });

    // 名刺プレビュー（モバイル）
    document.getElementById("business-card-input").addEventListener("change", e => {
      const container = document.getElementById("business-card-preview");
      container.innerHTML = ""; // 既存のプレビューをクリア
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.createElement("img");
          img.src = ev.target.result;
          img.alt = file.name;
          img.className = "w-full h-auto object-contain rounded max-h-32"; // サイズ調整例
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // 名刺プレビュー（PC）
    document.getElementById("pc-business-card-input").addEventListener("change", e => {
      const container = document.getElementById("pc-business-card-preview");
      container.innerHTML = ""; // 既存のプレビューをクリア
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.createElement("img");
          img.src = ev.target.result;
          img.alt = file.name;
          img.className = "w-full h-auto object-contain rounded max-h-40"; // PC用により大きく
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // ヒアリングシートプレビュー（累積表示 - モバイル）
    const hearingInput = document.getElementById("hearing-seed-input");
    const hearingPreview = document.getElementById("hearing-seed-preview");
    
    hearingInput.addEventListener("change", e => {
      Array.from(e.target.files).forEach(file => {
        // 同じファイルがすでに追加されていないか確認（より厳密なチェックが必要な場合あり）
        const isAlreadyAdded = Array.from(hearingPreview.querySelectorAll('img')).some(img => img.alt === file.name);
        if (!isAlreadyAdded) {
           const reader = new FileReader();
           reader.onload = ev => {
             const imgContainer = document.createElement("div"); // コンテナを追加して削除ボタンなどを付けやすくする
             imgContainer.className = "relative w-16 h-16"; // サイズを小さくする例
             const img = document.createElement("img");
             img.src = ev.target.result;
             img.alt = file.name;
             img.className = "w-full h-full object-cover rounded";
             imgContainer.appendChild(img);
             hearingPreview.appendChild(imgContainer);
           };
           reader.readAsDataURL(file);
        }
      });
      // 再選択のために input の value をリセット（必要に応じて）
      // e.target.value = "";
    });

    // ヒアリングシートプレビュー（累積表示 - PC）
    const pcHearingInput = document.getElementById("pc-hearing-seed-input");
    const pcHearingPreview = document.getElementById("pc-hearing-seed-preview");
    
    pcHearingInput.addEventListener("change", e => {
      Array.from(e.target.files).forEach(file => {
        const isAlreadyAdded = Array.from(pcHearingPreview.querySelectorAll('img')).some(img => img.alt === file.name);
        if (!isAlreadyAdded) {
           const reader = new FileReader();
           reader.onload = ev => {
             const imgContainer = document.createElement("div");
             imgContainer.className = "relative w-20 h-20"; // PC用により大きく
             const img = document.createElement("img");
             img.src = ev.target.result;
             img.alt = file.name;
             img.className = "w-full h-full object-cover rounded";
             imgContainer.appendChild(img);
             pcHearingPreview.appendChild(imgContainer);
           };
           reader.readAsDataURL(file);
        }
      });
    });

    // カメラ機能
    let currentCameraTarget = null; // 'business_card' または 'hearing_seed'
    let videoStream = null;
    const cameraModal = document.getElementById("camera-modal");
    const cameraVideo = document.getElementById("camera-video");
    const cameraCanvas = document.getElementById("camera-canvas");
    const cameraModalTitle = document.getElementById("camera-modal-title");

    // カメラボタンのイベントリスナー（モバイル）
    document.getElementById("business-card-camera").addEventListener("click", () => {
      openCamera("business_card");
    });

    document.getElementById("hearing-sheet-camera").addEventListener("click", () => {
      openCamera("hearing_seed");
    });

    // カメラボタンのイベントリスナー（PC）
    document.getElementById("pc-business-card-camera").addEventListener("click", () => {
      openCamera("pc_business_card");
    });

    document.getElementById("pc-hearing-sheet-camera").addEventListener("click", () => {
      openCamera("pc_hearing_seed");
    });

    // カメラを開く関数
    function openCamera(target) {
      console.log("openCamera関数が呼び出されました。対象:", target);
      currentCameraTarget = target;
      
      // タイトルを設定
      if (target === "business_card" || target === "pc_business_card") {
        cameraModalTitle.textContent = "名刺の写真を撮影";
      } else {
        cameraModalTitle.textContent = "ヒアリングシートの写真を撮影";
      }

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.error("カメラAPI非対応");
        alert("このブラウザはカメラ機能をサポートしていません。");
        return;
      }

      const hostname = window.location.hostname;
      const isLocalhost = hostname === "localhost" || hostname === "127.0.0.1";
      const isPrivateIP = /^(192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[0-1]))/.test(hostname);
      const isHttps = window.location.protocol === "https:";

      if (!isLocalhost && !isPrivateIP && !isHttps) {
         console.warn("HTTPS接続が必要です");
         alert("セキュリティ上の理由から、カメラへのアクセスにはHTTPS接続が必要です。");
         return;
      }

      cameraModal.classList.remove("hidden");
      console.log("カメラモーダル表示");

      const constraints = { video: { facingMode: "environment" }, audio: false }; //背面カメラ優先

      console.log("カメラアクセス試行...");
      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          console.log("カメラアクセス成功");
          videoStream = stream;
          cameraVideo.srcObject = stream;
          cameraVideo.play(); // 再生を開始
        })
        .catch(err => {
          console.error("カメラアクセス失敗:", err);
          // エラーメッセージ表示 (前のコードと同様)
          let errorMessage = "カメラへのアクセスに失敗。";
          if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") errorMessage += "許可が拒否されました。設定を確認してください。";
          else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") errorMessage += "カメラが見つかりません。";
          else if (err.name === "NotReadableError" || err.name === "TrackStartError") errorMessage += "カメラを読み取れません。他のアプリで使用中かも？";
          else errorMessage += `エラー詳細: ${err.name}`;
          alert(errorMessage + "\n\nブラウザ情報: " + navigator.userAgent);
          closeCamera(); // エラー時はモーダルを閉じる
        });
    }

    // 撮影ボタンのイベントリスナー
    document.getElementById("camera-capture").addEventListener("click", () => {
      if (!videoStream) {
          console.error("ビデオストリームがありません");
          return;
      }
      cameraCanvas.width = cameraVideo.videoWidth;
      cameraCanvas.height = cameraVideo.videoHeight;
      const context = cameraCanvas.getContext("2d");
      if (!context) {
          console.error("Canvasコンテキストを取得できませんでした");
          return;
      }
      context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);

      cameraCanvas.toBlob(blob => {
        if (!blob) {
            console.error("Blobの作成に失敗しました");
            alert("画像の保存に失敗しました。");
            return;
        }
        const fileName = `camera_${currentCameraTarget}_${Date.now()}.jpg`;
        const file = new File([blob], fileName, { type: "image/jpeg" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);

        let inputElement;
        if (currentCameraTarget === "business_card") {
          inputElement = document.getElementById("business-card-input");
          // 名刺は1枚なので、既存のファイルを置き換える
          inputElement.files = dataTransfer.files;
        } else if (currentCameraTarget === "pc_business_card") {
          inputElement = document.getElementById("pc-business-card-input");
          // 名刺は1枚なので、既存のファイルを置き換える
          inputElement.files = dataTransfer.files;
        } else if (currentCameraTarget === "hearing_seed") {
          inputElement = document.getElementById("hearing-seed-input");
          // ヒアリングシートは複数可なので、既存のファイルに追加する
          const existingFiles = inputElement.files ? Array.from(inputElement.files) : [];
          const combinedTransfer = new DataTransfer();
          existingFiles.forEach(f => combinedTransfer.items.add(f));
          combinedTransfer.items.add(file); // 新しいファイルを追加
          inputElement.files = combinedTransfer.files;
        } else if (currentCameraTarget === "pc_hearing_seed") {
          inputElement = document.getElementById("pc-hearing-seed-input");
          // ヒアリングシートは複数可なので、既存のファイルに追加する
          const existingFiles = inputElement.files ? Array.from(inputElement.files) : [];
          const combinedTransfer = new DataTransfer();
          existingFiles.forEach(f => combinedTransfer.items.add(f));
          combinedTransfer.items.add(file); // 新しいファイルを追加
          inputElement.files = combinedTransfer.files;
        } else {
            console.error("不明なカメラターゲット:", currentCameraTarget);
            return; // 不明な場合は何もしない
        }

        // 変更イベントを発火させてプレビューなどを更新
        if (inputElement) {
            inputElement.dispatchEvent(new Event("change", { bubbles: true }));
        }
        closeCamera(); // 撮影後モーダルを閉じる

      }, "image/jpeg", 0.9); // JPEG形式、品質90%
    });

    // キャンセルボタンのイベントリスナー
    document.getElementById("camera-cancel").addEventListener("click", closeCamera);

    // カメラを閉じる関数
    function closeCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
        cameraVideo.srcObject = null; // ビデオ表示をクリア
      }
      cameraModal.classList.add("hidden");
      console.log("カメラモーダル非表示");
    }

    // 送信時にボタン無効化＆スピナー表示（モバイル）
    const mobileForm = document.getElementById("mobile-upload-form");
    if (mobileForm) {
      mobileForm.addEventListener("submit", (e) => {
        const btn = document.getElementById("submit-btn");
        const btnText = document.getElementById("btn-text");
        const btnSpinner = document.getElementById("btn-spinner");

        btnText.classList.add("hidden");
        btnSpinner.classList.remove("hidden");
        btn.disabled = true;
      });
    }

    // 送信時にボタン無効化＆スピナー表示（PC）
    const pcForm = document.getElementById("pc-upload-form");
    if (pcForm) {
      pcForm.addEventListener("submit", (e) => {
        const btn = document.getElementById("pc-submit-btn");
        const btnText = document.getElementById("pc-btn-text");
        const btnSpinner = document.getElementById("pc-btn-spinner");

        btnText.classList.add("hidden");
        btnSpinner.classList.remove("hidden");
        btn.disabled = true;
      });
    }

    // --- ▲▲▲ 初期化・既存機能 ▲▲▲ ---



  </script>
</body>
</html>