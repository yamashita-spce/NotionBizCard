<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ååˆºå‡¦ç†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* å¼•ãç¶™ããƒªã‚¹ãƒˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰ */
    #handover-list-table th,
    #handover-list-table td {
      padding: 8px 12px;
      border: 1px solid #e5e7eb; /* gray-200 */
      text-align: left;
    }
    #handover-list-table tbody tr:hover {
      background-color: #f3f4f6; /* gray-100 */
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- PCç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="hidden lg:block">
    <div class="container mx-auto px-8 py-12">
      <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg">
        <div class="p-8">
          <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">ãƒªãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
          

          {% if message %}
            <div class="mb-6 p-4 text-center rounded-lg {{ 'bg-green-50 text-green-700 border border-green-200' if success == '1' else 'bg-red-50 text-red-700 border border-red-200' }}">
              {{ message|safe }}
            </div>
          {% endif %}

          <form method="post" enctype="multipart/form-data" id="pc-upload-form" class="space-y-8">
            
            <!-- ç¬¬1ã‚»ã‚¯ã‚·ãƒ§ãƒ³: åŸºæœ¬æƒ…å ± -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              
              <!-- å·¦ã‚«ãƒ©ãƒ : æ‹…å½“è€…ãƒ»ååˆºæƒ…å ± -->
              <div class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">åŸºæœ¬æƒ…å ±</h2>
                
                <!-- æ‹…å½“è€… -->
                <div>
                  <label for="pc-tantosha-input" class="block text-sm font-medium text-gray-700 mb-2">æ‹…å½“è€… <span class="text-red-500">*</span></label>
                  <select name="tantosha" id="pc-tantosha-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    <option value="" disabled {% if not tantosha_value %}selected{% endif %}>æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    {% for assignee in assignees_list %}
                      <option value="{{ assignee }}" {% if assignee == tantosha_value %}selected{% endif %}>{{ assignee }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- ååˆºæƒ…å ± -->
                <div>
                  <label class="block text-lg font-medium text-gray-700 mb-3">ååˆºæƒ…å ±</label>
                  
                  <!-- å…¥åŠ›æ–¹æ³•é¸æŠ -->
                  <div class="mb-4">
                    <div class="flex space-x-6">
                      <label class="inline-flex items-center">
                        <input type="radio" name="input_method" value="image" id="pc-input-method-image" class="form-radio h-5 w-5 text-indigo-600" checked>
                        <span class="ml-3 text-base">ååˆºç”»åƒ</span>
                      </label>
                      <label class="inline-flex items-center">
                        <input type="radio" name="input_method" value="manual" id="pc-input-method-manual" class="form-radio h-5 w-5 text-indigo-600">
                        <span class="ml-3 text-base">æ‰‹å…¥åŠ›</span>
                      </label>
                    </div>
                  </div>
                  
                  <!-- ååˆºç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                  <div id="pc-image-input-section">
                    <div class="flex space-x-3 mb-4">
                      <label for="pc-business-card-input" class="cursor-pointer inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                      </label>
                      <button type="button" id="pc-business-card-camera" class="inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                        ğŸ“· ã‚«ãƒ¡ãƒ©
                      </button>
                    </div>
                    <input type="file" name="business_card" id="pc-business-card-input" accept="image/*" class="hidden">
                    <div id="pc-business-card-preview" class="mt-3 grid grid-cols-1 gap-3"></div>
                  </div>
                  
                  <!-- æ‰‹å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                  <div id="pc-manual-input-section" class="hidden space-y-4">
                    <div>
                      <label for="pc-manual-company" class="block text-sm font-medium text-gray-700 mb-2">ä¼šç¤¾å <span class="text-red-500">*</span></label>
                      <input type="text" name="manual_company" id="pc-manual-company" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="æ ªå¼ä¼šç¤¾â—‹â—‹">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label for="pc-manual-department" class="block text-sm font-medium text-gray-700 mb-2">éƒ¨ç½²å</label>
                        <input type="text" name="manual_department" id="pc-manual-department" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="å–¶æ¥­éƒ¨">
                      </div>
                      <div>
                        <label for="pc-manual-position" class="block text-sm font-medium text-gray-700 mb-2">å½¹è·å</label>
                        <input type="text" name="manual_position" id="pc-manual-position" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="èª²é•·">
                      </div>
                    </div>
                    <div>
                      <label for="pc-manual-name" class="block text-sm font-medium text-gray-700 mb-2">æ‹…å½“è€…æ°å <span class="text-red-500">*</span></label>
                      <input type="text" name="manual_name" id="pc-manual-name" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ç”°ä¸­å¤ªéƒ">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label for="pc-manual-email" class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" name="manual_email" id="pc-manual-email" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="tanaka@example.com">
                      </div>
                      <div>
                        <label for="pc-manual-phone" class="block text-sm font-medium text-gray-700 mb-2">é›»è©±ç•ªå·</label>
                        <input type="tel" name="manual_phone" id="pc-manual-phone" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="03-1234-5678">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆ -->
                <div>
                  <label class="block text-lg font-medium text-gray-700 mb-3">ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆç”»åƒï¼ˆè¤‡æ•°å¯ï¼‰</label>
                  <div class="flex space-x-3 mb-4">
                    <label for="pc-hearing-seed-input" class="cursor-pointer inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                      ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    </label>
                    <button type="button" id="pc-hearing-sheet-camera" class="inline-flex items-center px-6 py-3 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition text-base">
                      ğŸ“· ã‚«ãƒ¡ãƒ©
                    </button>
                  </div>
                  <input type="file" name="hearing_seed" id="pc-hearing-seed-input" multiple accept="image/*" class="hidden">
                  <div id="pc-hearing-seed-preview" class="mt-3 grid grid-cols-4 gap-3"></div>
                </div>
              </div>

              <!-- å³ã‚«ãƒ©ãƒ : ãƒ—ãƒ©ãƒ³ãƒ»ãƒšãƒ«ã‚½ãƒŠ -->
              <div class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">å–¶æ¥­æƒ…å ±</h2>
                
                <!-- ææ¡ˆãƒ—ãƒ©ãƒ³ -->
                <div>
                  <label for="pc-proposal-plan-input" class="block text-sm font-medium text-gray-700 mb-2">ææ¡ˆï¼ˆèˆˆå‘³ãŒã‚ã‚Šãã†ãªï¼‰ãƒ—ãƒ©ãƒ³ <span class="text-red-500">*</span></label>
                  <select name="proposal_plan" id="pc-proposal-plan-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    <option value="" disabled {% if not proposal_plan_value %}selected{% endif %}>ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    {% for plan in proposal_plan_list %}
                      <option value="{{ plan }}" {% if plan == proposal_plan_value %}selected{% endif %}>{{ plan }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- ãƒšãƒ«ã‚½ãƒŠ -->
                <div>
                  <h3 class="text-lg font-semibold text-gray-800 mb-4">ãƒšãƒ«ã‚½ãƒŠ</h3>
                  <div class="grid grid-cols-3 gap-4 mb-6">
                    <div>
                      <label for="pc-needs-input" class="block text-sm font-medium text-gray-700 mb-2">ãƒ‹ãƒ¼ã‚º <span class="text-red-500">*</span></label>
                      <select name="needs" id="pc-needs-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        <option value="" disabled {% if not needs_value %}selected{% endif %}>é¸æŠ</option>
                        {% for option_value, option_text in persona_options.needs %}
                          <option value="{{ option_value }}" {% if option_value == needs_value %}selected{% endif %}>{{ option_text }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div>
                      <label for="pc-authority-input" class="block text-sm font-medium text-gray-700 mb-2">æ±ºè£æ¨© <span class="text-red-500">*</span></label>
                      <select name="authority" id="pc-authority-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        <option value="" disabled {% if not authority_value %}selected{% endif %}>é¸æŠ</option>
                        {% for option_value, option_text in persona_options.authority %}
                          <option value="{{ option_value }}" {% if option_value == authority_value %}selected{% endif %}>{{ option_text }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div>
                      <label for="pc-timing-input" class="block text-sm font-medium text-gray-700 mb-2">å°å…¥æ™‚æœŸ <span class="text-red-500">*</span></label>
                      <select name="timing" id="pc-timing-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        <option value="" disabled {% if not timing_value %}selected{% endif %}>é¸æŠ</option>
                        {% for option_value, option_text in persona_options.timing %}
                          <option value="{{ option_value }}" {% if option_value == timing_value %}selected{% endif %}>{{ option_text }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <!-- ãƒªãƒ¼ãƒ‰ç²å¾—æ—¥ã¨ãƒœã‚¤ãƒ¬ã‚³ -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="pc-lead-date-input" class="block text-sm font-medium text-gray-700 mb-2">ãƒªãƒ¼ãƒ‰ç²å¾—æ—¥ (YYYY/M/Då½¢å¼)</label>
                    <input type="text" name="lead_date" id="pc-lead-date-input" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å½“æ—¥ã«ãªã‚Šã¾ã™" value="{{ lead_date_value }}" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                  </div>
                  <div>
                    <label for="pc-voice-recorder-loan-input" class="block text-sm font-medium text-gray-700 mb-2">ãƒœã‚¤ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼è²¸ã—å‡ºã—</label>
                    <input type="text" name="voice_recorder_loan" id="pc-voice-recorder-loan-input" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ç®¡ç†ç•ªå·ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šVR001ï¼‰" value="{{ voice_recorder_loan_value }}">
                  </div>
                </div>
              </div>
            </div>

            <!-- ç¬¬2ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ãƒ’ã‚¢ãƒªãƒ³ã‚°è©³ç´° -->
            <div class="border-t pt-8">
              <h2 class="text-xl font-semibold text-gray-800 mb-6">ãƒ’ã‚¢ãƒªãƒ³ã‚°è©³ç´°</h2>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label for="pc-current-situation-input" class="block text-sm font-medium text-gray-700 mb-2">ç¾çŠ¶</label>
                  <textarea name="current_situation" id="pc-current-situation-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ãŠå®¢æ§˜ã®ç¾åœ¨ã®çŠ¶æ³ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ current_situation_value }}</textarea>
                </div>
                <div>
                  <label for="pc-problem-input" class="block text-sm font-medium text-gray-700 mb-2">å•é¡Œ</label>
                  <textarea name="problem" id="pc-problem-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ãŠå®¢æ§˜ãŒæŠ±ãˆã¦ã„ã‚‹å•é¡Œã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ problem_value }}</textarea>
                </div>
                <div>
                  <label for="pc-most-important-need-input" class="block text-sm font-medium text-gray-700 mb-2">æœ€é‡è¦ãƒ‹ãƒ¼ã‚º</label>
                  <textarea name="most_important_need" id="pc-most-important-need-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ãŠå®¢æ§˜ãŒæœ€ã‚‚è§£æ±ºã—ãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ãƒ‹ãƒ¼ã‚ºã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ most_important_need_value }}</textarea>
                </div>
                <div>
                  <label for="pc-proposal-content-input" class="block text-sm font-medium text-gray-700 mb-2">ææ¡ˆå†…å®¹</label>
                  <textarea name="proposal_content" id="pc-proposal-content-input" rows="4" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="å…·ä½“çš„ãªææ¡ˆå†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ proposal_content_value }}</textarea>
                </div>
              </div>
              <div class="mt-4">
                <label for="pc-consideration-reason-input" class="block text-sm font-medium text-gray-700 mb-2">æ¤œè¨ç†ç”±</label>
                <textarea name="consideration_reason" id="pc-consideration-reason-input" rows="3" class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ãŠå®¢æ§˜ãŒææ¡ˆã‚’æ¤œè¨ã™ã‚‹ç†ç”±ã‚„èƒŒæ™¯ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ consideration_reason_value }}</textarea>
              </div>
            </div>

            <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
            <div class="flex items-center justify-center pt-6 border-t">
              <button id="pc-submit-btn" type="submit" class="px-12 py-4 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition flex items-center text-lg">
                <span id="pc-btn-text">å‡¦ç†é–‹å§‹</span>
                <svg id="pc-btn-spinner" class="hidden animate-spin ml-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
                </svg>
              </button>
            </div>


          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="lg:hidden flex items-center justify-center p-4 min-h-screen">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-semibold text-center mb-6">ãƒªãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>


    {% if message %}
      <p class="mt-4 text-center {{ 'text-green-600' if success == '1' else 'text-red-600' }}">
        {{ message|safe }}
      </p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="mobile-upload-form" class="space-y-6">
      <div>
        <label for="tantosha-input" class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“è€… <span class="text-red-500">*</span></label>
        <select name="tantosha" id="tantosha-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
          <option value="" disabled {% if not tantosha_value %}selected{% endif %}>æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          {% for assignee in assignees_list %}
            <option value="{{ assignee }}" {% if assignee == tantosha_value %}selected{% endif %}>{{ assignee }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block font-medium mb-1">ååˆºæƒ…å ±</label>
        
        <!-- å…¥åŠ›æ–¹æ³•é¸æŠ -->
        <div class="mb-3">
          <label class="inline-flex items-center mr-4">
            <input type="radio" name="input_method" value="image" id="input-method-image" class="form-radio" checked>
            <span class="ml-2">ååˆºç”»åƒ</span>
          </label>
          <label class="inline-flex items-center">
            <input type="radio" name="input_method" value="manual" id="input-method-manual" class="form-radio">
            <span class="ml-2">æ‰‹å…¥åŠ›</span>
          </label>
        </div>
        
        <!-- ååˆºç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="image-input-section">
          <div class="flex space-x-2">
            <label for="business-card-input" class="cursor-pointer inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
              ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </label>
            <button type="button" id="business-card-camera" class="inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
              ã‚«ãƒ¡ãƒ©
            </button>
          </div>
          <input type="file" name="business_card" id="business-card-input" accept="image/*" class="hidden">
          <div id="business-card-preview" class="mt-2 grid grid-cols-1 gap-2"></div>
        </div>
        
        <!-- æ‰‹å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="manual-input-section" class="hidden space-y-3">
          <div>
            <label for="manual-company" class="block text-sm font-medium text-gray-700 mb-1">ä¼šç¤¾å <span class="text-red-500">*</span></label>
            <input type="text" name="manual_company" id="manual-company" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="æ ªå¼ä¼šç¤¾â—‹â—‹">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="manual-department" class="block text-sm font-medium text-gray-700 mb-1">éƒ¨ç½²å</label>
              <input type="text" name="manual_department" id="manual-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="å–¶æ¥­éƒ¨">
            </div>
            <div>
              <label for="manual-position" class="block text-sm font-medium text-gray-700 mb-1">å½¹è·å</label>
              <input type="text" name="manual_position" id="manual-position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="èª²é•·">
            </div>
          </div>
          <div>
            <label for="manual-name" class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“è€…æ°å <span class="text-red-500">*</span></label>
            <input type="text" name="manual_name" id="manual-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ç”°ä¸­å¤ªéƒ">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="manual-email" class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" name="manual_email" id="manual-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="tanaka@example.com">
            </div>
            <div>
              <label for="manual-phone" class="block text-sm font-medium text-gray-700 mb-1">é›»è©±ç•ªå·</label>
              <input type="tel" name="manual_phone" id="manual-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="03-1234-5678">
            </div>
          </div>
        </div>
      </div>

      <div>
        <label class="block font-medium mb-1">ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆç”»åƒï¼ˆè¤‡æ•°å¯ï¼‰</label>
         <div class="flex space-x-2">
            <label for="hearing-seed-input" class="cursor-pointer inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </label>
            <button type="button" id="hearing-sheet-camera" class="inline-flex items-center px-4 py-2 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                ã‚«ãƒ¡ãƒ©
            </button>
        </div>
        <input type="file" name="hearing_seed" id="hearing-seed-input" multiple accept="image/*" class="hidden">
        <div id="hearing-seed-preview" class="mt-2 grid grid-cols-3 gap-2"></div>
      </div>

      
      <div>
        <label for="proposal-plan-input" class="block text-sm font-medium text-gray-700 mb-1">ææ¡ˆï¼ˆèˆˆå‘³ãŒã‚ã‚Šãã†ãªï¼‰ãƒ—ãƒ©ãƒ³<span class="text-red-500">*</span></label>
        <select name="proposal_plan" id="proposal-plan-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
          <option value="" disabled {% if not proposal_plan_value %}selected{% endif %}>ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          {% for plan in proposal_plan_list %}
            <option value="{{ plan }}" {% if plan == proposal_plan_value %}selected{% endif %}>{{ plan }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- ã“ã“ã‹ã‚‰ãƒšãƒ«ã‚½ãƒŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <hr class="border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800 -mb-2 pt-2">ãƒšãƒ«ã‚½ãƒŠ</h2>

      <div class="grid grid-cols-3 gap-4">
        <div class="flex-1">
            <label for="needs-input" class="block text-sm font-medium text-gray-700 mb-1">ãƒ‹ãƒ¼ã‚º<span class="text-red-500">*</span></label>
            <select name="needs" id="needs-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                <option value="" disabled {% if not needs_value %}selected{% endif %}>é¸æŠ</option>
                {# persona_optionsè¾æ›¸ã®'needs'ã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹ãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ— #}
                {% for option_value, option_text in persona_options.needs %}
                  <option value="{{ option_value }}" {% if option_value == needs_value %}selected{% endif %}>{{ option_text }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="flex-1">
            <label for="authority-input" class="block text-sm font-medium text-gray-700 mb-1">æ±ºè£æ¨©<span class="text-red-500">*</span></label>
            <select name="authority" id="authority-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                <option value="" disabled {% if not authority_value %}selected{% endif %}>é¸æŠ</option>
                {# persona_optionsè¾æ›¸ã®'authority'ã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹ãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ— #}
                {% for option_value, option_text in persona_options.authority %}
                  <option value="{{ option_value }}" {% if option_value == authority_value %}selected{% endif %}>{{ option_text }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="flex-1">
            <label for="timing-input" class="block text-sm font-medium text-gray-700 mb-1">å°å…¥æ™‚æœŸ<span class="text-red-500">*</span></label>
            <select name="timing" id="timing-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                <option value="" disabled {% if not timing_value %}selected{% endif %}>é¸æŠ</option>
                {# persona_optionsè¾æ›¸ã®'timing'ã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹ãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ— #}
                {% for option_value, option_text in persona_options.timing %}
                  <option value="{{ option_value }}" {% if option_value == timing_value %}selected{% endif %}>{{ option_text }}</option>
                {% endfor %}
            </select>
        </div>
      </div>

      <hr class="border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800 -mb-2 pt-2">ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹</h2>

      <div>
        <label for="current-situation-input" class="block text-sm font-medium text-gray-700 mb-1">ç¾çŠ¶</label>
        <textarea name="current_situation" id="current-situation-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ç¾åœ¨ã®ãŠå®¢æ§˜ã®çŠ¶æ³ã«ã¤ã„ã¦è¨˜è¿°ã—ã¦ãã ã•ã„">{{ current_situation_value }}</textarea>
      </div>

      <div>
        <label for="problem-input" class="block text-sm font-medium text-gray-700 mb-1">å•é¡Œ</label>
        <textarea name="problem" id="problem-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ãŠå®¢æ§˜ãŒæŠ±ãˆã¦ã„ã‚‹å•é¡Œç‚¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ problem_value }}</textarea>
      </div>

      <div>
        <label for="most-important-need-input" class="block text-sm font-medium text-gray-700 mb-1">æœ€é‡è¦ãƒ‹ãƒ¼ã‚º</label>
        <textarea name="most_important_need" id="most-important-need-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ãŠå®¢æ§˜ãŒæœ€ã‚‚è§£æ±ºã—ãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ãƒ‹ãƒ¼ã‚ºã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ most_important_need_value }}</textarea>
      </div>

      <div>
        <label for="proposal-content-input" class="block text-sm font-medium text-gray-700 mb-1">ææ¡ˆå†…å®¹</label>
        <textarea name="proposal_content" id="proposal-content-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="å…·ä½“çš„ãªææ¡ˆå†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ proposal_content_value }}</textarea>
      </div>

      <div>
        <label for="consideration-reason-input" class="block text-sm font-medium text-gray-700 mb-1">æ¤œè¨ç†ç”±</label>
        <textarea name="consideration_reason" id="consideration-reason-input" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ãŠå®¢æ§˜ãŒææ¡ˆã‚’æ¤œè¨ã™ã‚‹ç†ç”±ã‚„èƒŒæ™¯ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">{{ consideration_reason_value }}</textarea>
      </div>

      <div>
        <label for="lead-date-input" class="block font-medium">ãƒªãƒ¼ãƒ‰ç²å¾—æ—¥ (YYYY/M/Då½¢å¼)</label> <input type="text" name="lead_date" id="lead-date-input" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å½“æ—¥ã«ãªã‚Šã¾ã™" value="{{ lead_date_value }}" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"> </div>

      <div>
        <label for="voice-recorder-loan-input" class="block text-sm font-medium text-gray-700 mb-1">ãƒœã‚¤ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼è²¸ã—å‡ºã—</label>
        <input type="text" name="voice_recorder_loan" id="voice-recorder-loan-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ç®¡ç†ç•ªå·ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šVR001ï¼‰" value="{{ voice_recorder_loan_value }}">
        <p class="mt-1 text-xs text-gray-500">ãƒœã‚¤ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼ã‚’è²¸ã—å‡ºã—ãŸå ´åˆã®ç®¡ç†ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      </div>

      <div class="flex items-center justify-center pt-4">
          <button id="submit-btn" type="submit" class="w-full py-3 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition flex items-center justify-center">
              <span id="btn-text">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
              <svg id="btn-spinner" class="hidden animate-spin ml-2 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/></svg>
          </button>
      </div>


    </form>

    </div>
  </div>

  <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-4 rounded-lg max-w-lg w-full">
        <h3 class="text-lg font-medium mb-2" id="camera-modal-title">å†™çœŸã‚’æ’®å½±</h3>
        <div class="relative">
          <video id="camera-video" class="w-full h-64 bg-black object-cover" autoplay playsinline></video>
          <canvas id="camera-canvas" class="hidden"></canvas>
        </div>
        <div class="flex justify-between mt-4">
          <button type="button" id="camera-cancel" class="px-4 py-2 bg-gray-200 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" id="camera-capture" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">æ’®å½±</button>
        </div>
    </div>
  </div>

  <script>
    // å…¥åŠ›æ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆPCãƒ»ãƒ¢ãƒã‚¤ãƒ«å…±é€šï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®è¦ç´ 
      const imageRadio = document.getElementById('input-method-image');
      const manualRadio = document.getElementById('input-method-manual');
      const imageSection = document.getElementById('image-input-section');
      const manualSection = document.getElementById('manual-input-section');
      const businessCardInput = document.getElementById('business-card-input');
      const manualCompany = document.getElementById('manual-company');
      const manualName = document.getElementById('manual-name');
      
      // PCç”¨ã®è¦ç´ 
      const pcImageRadio = document.getElementById('pc-input-method-image');
      const pcManualRadio = document.getElementById('pc-input-method-manual');
      const pcImageSection = document.getElementById('pc-image-input-section');
      const pcManualSection = document.getElementById('pc-manual-input-section');
      const pcBusinessCardInput = document.getElementById('pc-business-card-input');
      const pcManualCompany = document.getElementById('pc-manual-company');
      const pcManualName = document.getElementById('pc-manual-name');
      
      function toggleInputMethod() {
        // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®å‡¦ç†
        if (imageRadio && manualRadio) {
          if (manualRadio.checked) {
            imageSection.classList.add('hidden');
            manualSection.classList.remove('hidden');
            businessCardInput.removeAttribute('required');
            manualCompany.setAttribute('required', 'required');
            manualName.setAttribute('required', 'required');
          } else {
            imageSection.classList.remove('hidden');
            manualSection.classList.add('hidden');
            businessCardInput.setAttribute('required', 'required');
            manualCompany.removeAttribute('required');
            manualName.removeAttribute('required');
          }
        }
      }
      
      function togglePcInputMethod() {
        // PCç”¨ã®å‡¦ç†
        if (pcImageRadio && pcManualRadio) {
          if (pcManualRadio.checked) {
            pcImageSection.classList.add('hidden');
            pcManualSection.classList.remove('hidden');
            pcBusinessCardInput.removeAttribute('required');
            pcManualCompany.setAttribute('required', 'required');
            pcManualName.setAttribute('required', 'required');
          } else {
            pcImageSection.classList.remove('hidden');
            pcManualSection.classList.add('hidden');
            pcBusinessCardInput.setAttribute('required', 'required');
            pcManualCompany.removeAttribute('required');
            pcManualName.removeAttribute('required');
          }
        }
      }
      
      // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      if (imageRadio && manualRadio) {
        imageRadio.addEventListener('change', toggleInputMethod);
        manualRadio.addEventListener('change', toggleInputMethod);
        toggleInputMethod(); // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
      }
      
      // PCç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      if (pcImageRadio && pcManualRadio) {
        pcImageRadio.addEventListener('change', togglePcInputMethod);
        pcManualRadio.addEventListener('change', togglePcInputMethod);
        togglePcInputMethod(); // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
      }
    });
    // --- â–¼â–¼â–¼ åˆæœŸåŒ–ãƒ»æ—¢å­˜æ©Ÿèƒ½ â–¼â–¼â–¼ ---

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèª
    window.addEventListener('DOMContentLoaded', () => {
      // ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ç¢ºèª
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’æ±‚ã‚ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        if (!localStorage.getItem('cameraPermissionRequested')) {
          setTimeout(() => {
            if (confirm('ã“ã®ã‚¢ãƒ—ãƒªã¯ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿ')) {
              // ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã‚‹
              navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                  // è¨±å¯ã•ã‚ŒãŸå ´åˆã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                  stream.getTracks().forEach(track => track.stop());
                  console.log('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ');
                  localStorage.setItem('cameraPermissionGranted', 'true');
                })
                .catch(err => {
                  console.error('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ:', err);
                });
            }
            // è¨±å¯ã‚’æ±‚ã‚ãŸã“ã¨ã‚’è¨˜éŒ²
            localStorage.setItem('cameraPermissionRequested', 'true');
          }, 1000); // 1ç§’å¾Œã«è¡¨ç¤º
        }
      }
    });

    // ååˆºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
    document.getElementById("business-card-input").addEventListener("change", e => {
      const container = document.getElementById("business-card-preview");
      container.innerHTML = ""; // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.createElement("img");
          img.src = ev.target.result;
          img.alt = file.name;
          img.className = "w-full h-auto object-contain rounded max-h-32"; // ã‚µã‚¤ã‚ºèª¿æ•´ä¾‹
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // ååˆºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆPCï¼‰
    document.getElementById("pc-business-card-input").addEventListener("change", e => {
      const container = document.getElementById("pc-business-card-preview");
      container.innerHTML = ""; // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.createElement("img");
          img.src = ev.target.result;
          img.alt = file.name;
          img.className = "w-full h-auto object-contain rounded max-h-40"; // PCç”¨ã«ã‚ˆã‚Šå¤§ãã
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç´¯ç©è¡¨ç¤º - ãƒ¢ãƒã‚¤ãƒ«ï¼‰
    const hearingInput = document.getElementById("hearing-seed-input");
    const hearingPreview = document.getElementById("hearing-seed-preview");
    
    hearingInput.addEventListener("change", e => {
      Array.from(e.target.files).forEach(file => {
        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªï¼ˆã‚ˆã‚Šå³å¯†ãªãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆã‚ã‚Šï¼‰
        const isAlreadyAdded = Array.from(hearingPreview.querySelectorAll('img')).some(img => img.alt === file.name);
        if (!isAlreadyAdded) {
           const reader = new FileReader();
           reader.onload = ev => {
             const imgContainer = document.createElement("div"); // ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã—ã¦å‰Šé™¤ãƒœã‚¿ãƒ³ãªã©ã‚’ä»˜ã‘ã‚„ã™ãã™ã‚‹
             imgContainer.className = "relative w-16 h-16"; // ã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ä¾‹
             const img = document.createElement("img");
             img.src = ev.target.result;
             img.alt = file.name;
             img.className = "w-full h-full object-cover rounded";
             imgContainer.appendChild(img);
             hearingPreview.appendChild(imgContainer);
           };
           reader.readAsDataURL(file);
        }
      });
      // å†é¸æŠã®ãŸã‚ã« input ã® value ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      // e.target.value = "";
    });

    // ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç´¯ç©è¡¨ç¤º - PCï¼‰
    const pcHearingInput = document.getElementById("pc-hearing-seed-input");
    const pcHearingPreview = document.getElementById("pc-hearing-seed-preview");
    
    pcHearingInput.addEventListener("change", e => {
      Array.from(e.target.files).forEach(file => {
        const isAlreadyAdded = Array.from(pcHearingPreview.querySelectorAll('img')).some(img => img.alt === file.name);
        if (!isAlreadyAdded) {
           const reader = new FileReader();
           reader.onload = ev => {
             const imgContainer = document.createElement("div");
             imgContainer.className = "relative w-20 h-20"; // PCç”¨ã«ã‚ˆã‚Šå¤§ãã
             const img = document.createElement("img");
             img.src = ev.target.result;
             img.alt = file.name;
             img.className = "w-full h-full object-cover rounded";
             imgContainer.appendChild(img);
             pcHearingPreview.appendChild(imgContainer);
           };
           reader.readAsDataURL(file);
        }
      });
    });

    // ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½
    let currentCameraTarget = null; // 'business_card' ã¾ãŸã¯ 'hearing_seed'
    let videoStream = null;
    const cameraModal = document.getElementById("camera-modal");
    const cameraVideo = document.getElementById("camera-video");
    const cameraCanvas = document.getElementById("camera-canvas");
    const cameraModalTitle = document.getElementById("camera-modal-title");

    // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
    document.getElementById("business-card-camera").addEventListener("click", () => {
      openCamera("business_card");
    });

    document.getElementById("hearing-sheet-camera").addEventListener("click", () => {
      openCamera("hearing_seed");
    });

    // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆPCï¼‰
    document.getElementById("pc-business-card-camera").addEventListener("click", () => {
      openCamera("pc_business_card");
    });

    document.getElementById("pc-hearing-sheet-camera").addEventListener("click", () => {
      openCamera("pc_hearing_seed");
    });

    // ã‚«ãƒ¡ãƒ©ã‚’é–‹ãé–¢æ•°
    function openCamera(target) {
      console.log("openCameraé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸã€‚å¯¾è±¡:", target);
      currentCameraTarget = target;
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
      if (target === "business_card" || target === "pc_business_card") {
        cameraModalTitle.textContent = "ååˆºã®å†™çœŸã‚’æ’®å½±";
      } else {
        cameraModalTitle.textContent = "ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆã®å†™çœŸã‚’æ’®å½±";
      }

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.error("ã‚«ãƒ¡ãƒ©APIéå¯¾å¿œ");
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const hostname = window.location.hostname;
      const isLocalhost = hostname === "localhost" || hostname === "127.0.0.1";
      const isPrivateIP = /^(192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[0-1]))/.test(hostname);
      const isHttps = window.location.protocol === "https:";

      if (!isLocalhost && !isPrivateIP && !isHttps) {
         console.warn("HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™");
         alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ã€ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚");
         return;
      }

      cameraModal.classList.remove("hidden");
      console.log("ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º");

      const constraints = { video: { facingMode: "environment" }, audio: false }; //èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆ

      console.log("ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ...");
      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          console.log("ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ");
          videoStream = stream;
          cameraVideo.srcObject = stream;
          cameraVideo.play(); // å†ç”Ÿã‚’é–‹å§‹
        })
        .catch(err => {
          console.error("ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—:", err);
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º (å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒæ§˜)
          let errorMessage = "ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã€‚";
          if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") errorMessage += "è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
          else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") errorMessage += "ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
          else if (err.name === "NotReadableError" || err.name === "TrackStartError") errorMessage += "ã‚«ãƒ¡ãƒ©ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ä¸­ã‹ã‚‚ï¼Ÿ";
          else errorMessage += `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${err.name}`;
          alert(errorMessage + "\n\nãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±: " + navigator.userAgent);
          closeCamera(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        });
    }

    // æ’®å½±ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById("camera-capture").addEventListener("click", () => {
      if (!videoStream) {
          console.error("ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
      }
      cameraCanvas.width = cameraVideo.videoWidth;
      cameraCanvas.height = cameraVideo.videoHeight;
      const context = cameraCanvas.getContext("2d");
      if (!context) {
          console.error("Canvasã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
          return;
      }
      context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);

      cameraCanvas.toBlob(blob => {
        if (!blob) {
            console.error("Blobã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
            alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            return;
        }
        const fileName = `camera_${currentCameraTarget}_${Date.now()}.jpg`;
        const file = new File([blob], fileName, { type: "image/jpeg" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);

        let inputElement;
        if (currentCameraTarget === "business_card") {
          inputElement = document.getElementById("business-card-input");
          // ååˆºã¯1æšãªã®ã§ã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆã‚‹
          inputElement.files = dataTransfer.files;
        } else if (currentCameraTarget === "pc_business_card") {
          inputElement = document.getElementById("pc-business-card-input");
          // ååˆºã¯1æšãªã®ã§ã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆã‚‹
          inputElement.files = dataTransfer.files;
        } else if (currentCameraTarget === "hearing_seed") {
          inputElement = document.getElementById("hearing-seed-input");
          // ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆã¯è¤‡æ•°å¯ãªã®ã§ã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã™ã‚‹
          const existingFiles = inputElement.files ? Array.from(inputElement.files) : [];
          const combinedTransfer = new DataTransfer();
          existingFiles.forEach(f => combinedTransfer.items.add(f));
          combinedTransfer.items.add(file); // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
          inputElement.files = combinedTransfer.files;
        } else if (currentCameraTarget === "pc_hearing_seed") {
          inputElement = document.getElementById("pc-hearing-seed-input");
          // ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆã¯è¤‡æ•°å¯ãªã®ã§ã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã™ã‚‹
          const existingFiles = inputElement.files ? Array.from(inputElement.files) : [];
          const combinedTransfer = new DataTransfer();
          existingFiles.forEach(f => combinedTransfer.items.add(f));
          combinedTransfer.items.add(file); // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
          inputElement.files = combinedTransfer.files;
        } else {
            console.error("ä¸æ˜ãªã‚«ãƒ¡ãƒ©ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ:", currentCameraTarget);
            return; // ä¸æ˜ãªå ´åˆã¯ä½•ã‚‚ã—ãªã„
        }

        // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã©ã‚’æ›´æ–°
        if (inputElement) {
            inputElement.dispatchEvent(new Event("change", { bubbles: true }));
        }
        closeCamera(); // æ’®å½±å¾Œãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹

      }, "image/jpeg", 0.9); // JPEGå½¢å¼ã€å“è³ª90%
    });

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById("camera-cancel").addEventListener("click", closeCamera);

    // ã‚«ãƒ¡ãƒ©ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
        cameraVideo.srcObject = null; // ãƒ“ãƒ‡ã‚ªè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
      }
      cameraModal.classList.add("hidden");
      console.log("ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º");
    }

    // é€ä¿¡æ™‚ã«ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ï¼†ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
    const mobileForm = document.getElementById("mobile-upload-form");
    if (mobileForm) {
      mobileForm.addEventListener("submit", (e) => {
        const btn = document.getElementById("submit-btn");
        const btnText = document.getElementById("btn-text");
        const btnSpinner = document.getElementById("btn-spinner");

        btnText.classList.add("hidden");
        btnSpinner.classList.remove("hidden");
        btn.disabled = true;
      });
    }

    // é€ä¿¡æ™‚ã«ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ï¼†ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºï¼ˆPCï¼‰
    const pcForm = document.getElementById("pc-upload-form");
    if (pcForm) {
      pcForm.addEventListener("submit", (e) => {
        const btn = document.getElementById("pc-submit-btn");
        const btnText = document.getElementById("pc-btn-text");
        const btnSpinner = document.getElementById("pc-btn-spinner");

        btnText.classList.add("hidden");
        btnSpinner.classList.remove("hidden");
        btn.disabled = true;
      });
    }

    // --- â–²â–²â–² åˆæœŸåŒ–ãƒ»æ—¢å­˜æ©Ÿèƒ½ â–²â–²â–² ---



  </script>
</body>
</html>